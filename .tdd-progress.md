# TDD Task: Fix auto-compaction unapproved plan cascade

**Status:** pending
**Created:** 2026-02-20
**Last Updated:** 2026-02-20

---

## Feature Description

During `/tdd-plan`, auto-compaction can cause the planner agent to lose the mandatory approval step, writing `.tdd-progress.md` directly. The stop hook then fires with imperative "Continue implementing." language, cascading into automatic implementation of an unapproved plan. This fix implements defense-in-depth with filesystem locks, pipe bypass detection, approval markers, and planning-phase messaging.

---

## Requirements

### Functional Requirements
- [ ] Pipe-to-file patterns (`| tee`, `| sponge`) are blocked by the bash guard
- [ ] `.tdd-plan-locked` file blocks writes to `.tdd-progress.md` until approval
- [ ] `rm .tdd-plan-locked` is allowed as a targeted exception
- [ ] Lock is created at planner start and cleaned up on planner stop
- [ ] Unapproved plans (no `Approved:` marker) allow session exit
- [ ] Stop hook messaging does not use imperative language
- [ ] `tdd-implement` verifies `Approved:` marker before starting
- [ ] Prompt-based compaction guard references lock file as ground truth

### Non-Functional Requirements
- [ ] All hooks pass `shellcheck -S warning`
- [ ] All existing tests continue passing (no regressions)
- [ ] MD5 checksums updated for modified hook scripts

---

## Test Specifications

## Slice 1: Pipe bypass detection in bash guard

**Status:** done

**Source:** `hooks/planner-bash-guard.sh`
**Tests:** `test/hooks/planner_bash_guard_test.sh`

### Test 1: Blocks pipe-to-file via tee to arbitrary path
Given: A command `cat README.md | tee .tdd-progress.md`
When: The bash guard evaluates the command
Then: Exit code is 2 and stderr contains "BLOCKED"

### Test 2: Allows pipe-to-file via tee to planning/ directory
Given: A command `cat notes.md | tee planning/notes.md`
When: The bash guard evaluates the command
Then: Exit code is 0

### Test 3: Allows pipe-to-file via tee to /dev/null
Given: A command `cat README.md | tee /dev/null`
When: The bash guard evaluates the command
Then: Exit code is 0

### Edge Cases

### Test 4: Blocks pipe-to-file via sponge to arbitrary path
Given: A command `cat README.md | sponge .tdd-progress.md`
When: The bash guard evaluates the command
Then: Exit code is 2 and stderr contains "BLOCKED"

### Acceptance Criteria
- [ ] All tests pass
- [ ] `| tee` and `| sponge` patterns detected and blocked for non-allowed targets
- [ ] Existing redirect tests still pass
- [ ] `shellcheck -S warning hooks/planner-bash-guard.sh` passes

### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** None | **Blocks:** Slice 2, Slice 6

---

## Slice 2: Lock-file gate and rm exception in bash guard

**Status:** done

**Source:** `hooks/planner-bash-guard.sh`
**Tests:** `test/hooks/planner_bash_guard_test.sh`

### Test 1: Blocks .tdd-progress.md reference while locked
Given: `.tdd-plan-locked` file exists in the working directory; a command references `.tdd-progress.md`
When: The bash guard evaluates the command
Then: Exit code is 2 and stderr contains "BLOCKED" and "not yet approved"

### Test 2: Allows .tdd-progress.md reference when unlocked
Given: No `.tdd-plan-locked` file exists; a command references `.tdd-progress.md`
When: The bash guard evaluates the command
Then: Exit code is 0

### Test 3: Allows rm .tdd-plan-locked
Given: A command `rm .tdd-plan-locked`
When: The bash guard evaluates the command
Then: Exit code is 0

### Test 4: Allows rm -f .tdd-plan-locked
Given: A command `rm -f .tdd-plan-locked`
When: The bash guard evaluates the command
Then: Exit code is 0

### Edge Cases

### Test 5: Blocks rm of arbitrary files
Given: A command `rm somefile.txt`
When: The bash guard evaluates the command
Then: Exit code is 2 and stderr contains "BLOCKED"

### Test 6: Blocks rm -rf
Given: A command `rm -rf /`
When: The bash guard evaluates the command
Then: Exit code is 2 and stderr contains "BLOCKED"

### Acceptance Criteria
- [ ] All tests pass
- [ ] Lock gate fires before allowlist loop
- [ ] rm exception fires before allowlist loop
- [ ] Only `rm .tdd-plan-locked` and `rm -f .tdd-plan-locked` allowed
- [ ] `shellcheck -S warning hooks/planner-bash-guard.sh` passes

### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** Slice 1 | **Blocks:** Slice 3, Slice 5, Slice 6

---

## Slice 3: Lock lifecycle — creation and cleanup

**Status:** done

**Source:** `hooks/hooks.json`, `hooks/validate-plan-output.sh`
**Tests:** `test/hooks/validate_plan_output_test.sh`

### Test 1: hooks.json SubagentStart for tdd-planner includes lock creation
Given: `hooks/hooks.json` exists
When: The SubagentStart entry for tdd-planner is inspected
Then: The command includes `touch .tdd-plan-locked`

### Test 2: validate-plan-output.sh removes lock file before stop_hook_active check
Given: `.tdd-plan-locked` exists and stop_hook_active is true
When: validate-plan-output.sh runs
Then: `.tdd-plan-locked` is removed; exit code is 0

### Test 3: validate-plan-output.sh removes lock file on normal stop
Given: `.tdd-plan-locked` exists and a valid plan file exists
When: validate-plan-output.sh runs with stop_hook_active=false
Then: `.tdd-plan-locked` is removed

### Edge Cases

### Test 4: Lock cleaned up even when no plan file exists (discard scenario)
Given: `.tdd-plan-locked` exists; no planning/*.md and no .tdd-progress.md
When: validate-plan-output.sh runs with stop_hook_active=false
Then: `.tdd-plan-locked` is removed; exit code is 0

### Acceptance Criteria
- [ ] All tests pass
- [ ] Lock created on SubagentStart before planner runs
- [ ] Lock unconditionally removed on SubagentStop (before stop_hook_active guard)
- [ ] Crash/discard/abort scenarios all clean up the lock
- [ ] `shellcheck -S warning hooks/validate-plan-output.sh` passes
- [ ] `hooks/hooks.json` is valid JSON

### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** skipped (no changes needed)

**Depends on:** Slice 2 | **Blocks:** Slice 5, Slice 6

---

## Slice 4: Approval marker check and simplified messaging

**Status:** done

**Source:** `hooks/check-tdd-progress.sh`
**Tests:** `test/hooks/check_tdd_progress_test.sh`

### Test 1: Unapproved plan allows session exit
Given: `.tdd-progress.md` exists with slices but no `Approved:` line
When: The stop hook runs
Then: Exit code is 0; no block decision output

### Test 2: Approved plan with remaining slices blocks exit
Given: `.tdd-progress.md` with `**Approved:** 2026-02-20` header; 3 slices, 1 done, 2 pending
When: The stop hook runs
Then: Block decision with reason containing "2 of 3 slices remaining"

### Test 3: Approved plan with all pending slices blocks exit
Given: `.tdd-progress.md` with `**Approved:** 2026-02-20` header; 3 slices, all pending
When: The stop hook runs
Then: Block decision with reason containing "3 of 3 slices remaining"

### Test 4: Block reason does not contain imperative language
Given: `.tdd-progress.md` with `**Approved:**` and remaining slices
When: The stop hook runs
Then: Reason does NOT contain "Continue implementing"

### Edge Cases

### Test 5: Single pending approved slice blocks exit
Given: `.tdd-progress.md` with `**Approved:**` and 1 pending slice
When: The stop hook runs
Then: Block decision with reason containing "1 of 1"

### Test 6: Approved marker with bold markdown formatting recognized
Given: `.tdd-progress.md` with `**Approved:** 2026-02-20T10:00:00Z`
When: The stop hook checks for approval
Then: File is treated as approved (blocks if remaining slices)

### Test 7: All in_progress slices with approved marker blocks exit
Given: `.tdd-progress.md` with `**Approved:**` and 2 slices, both in_progress
When: The stop hook runs
Then: Block decision with reason containing "2 of 2"

### Acceptance Criteria
- [ ] All tests pass
- [ ] Unapproved plans don't trap user in session
- [ ] Approved plans with remaining slices block with uniform "N of M slices remaining" message
- [ ] No imperative language ("Continue implementing") in any message
- [ ] No TERMINAL_SLICES sub-branching — Approved marker is the sole phase indicator
- [ ] Existing tests for check-tdd-progress.sh still pass
- [ ] `shellcheck -S warning hooks/check-tdd-progress.sh` passes

### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** None | **Blocks:** Slice 6

---

## Slice 5: Prompt updates — approval flow in SKILL.md and agent files

**Status:** done

**Source:** `skills/tdd-plan/SKILL.md`, `agents/tdd-planner.md`, `skills/tdd-implement/SKILL.md`
**Tests:** `test/hooks/planner_bash_guard_test.sh`

### Test 1: SKILL.md contains compaction guard instruction
Given: `skills/tdd-plan/SKILL.md` exists
When: The file content is inspected
Then: Contains "CRITICAL" and ".tdd-plan-locked" and "re-ask"

### Test 2: SKILL.md contains lock removal step
Given: `skills/tdd-plan/SKILL.md` exists
When: The file content is inspected
Then: Contains "rm .tdd-plan-locked" in a step before writing `.tdd-progress.md`

### Test 3: SKILL.md contains Approved header instruction
Given: `skills/tdd-plan/SKILL.md` exists
When: The file content is inspected
Then: Contains "Approved:" in the step 10 instructions

### Test 4: tdd-planner.md contains compaction guard and lock removal
Given: `agents/tdd-planner.md` exists
When: The file content is inspected
Then: Contains ".tdd-plan-locked" and "rm .tdd-plan-locked"

### Test 5: tdd-implement SKILL.md contains approval verification gate
Given: `skills/tdd-implement/SKILL.md` exists
When: The file content is inspected
Then: Contains "Approved:" verification check and message to run `/tdd-plan`

### Edge Cases

### Test 6: tdd-planner.md preserves existing mandatory approval sequence
Given: `agents/tdd-planner.md` exists
When: The file content is inspected
Then: Still contains "AskUserQuestion" and "Approve" and "Modify" and "Discard"

### Acceptance Criteria
- [ ] All tests pass
- [ ] Compaction guard text present in both SKILL.md and tdd-planner.md
- [ ] Lock removal step present before progress file write
- [ ] Approved header instruction present in step 10
- [ ] tdd-implement has Step -1 verification gate
- [ ] Existing mandatory approval sequence preserved in tdd-planner.md

### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** Slice 2, Slice 3 | **Blocks:** Slice 6

---

## Slice 6: Update hook checksums in integration test

**Status:** done

**Source:** `test/hooks/planner_bash_guard_test.sh`
**Tests:** `test/hooks/planner_bash_guard_test.sh`

### Test 1: test_existing_hooks_unmodified passes with updated checksums
Given: All hook files have been modified (planner-bash-guard.sh, validate-plan-output.sh, check-tdd-progress.sh)
When: `bashunit --filter "test_existing_hooks_unmodified" test/hooks/planner_bash_guard_test.sh` runs
Then: The test passes (exit code 0)

### Edge Cases

### Test 2: All hook test suites pass as integration check
Given: All slices 1-5 are complete
When: `bashunit test/hooks/` runs
Then: All tests pass with no failures

### Acceptance Criteria
- [ ] All tests pass
- [ ] MD5 checksums match actual file contents for all 5 checked hooks
- [ ] No test regressions across any test suite
- [ ] `shellcheck -S warning hooks/planner-bash-guard.sh hooks/validate-plan-output.sh hooks/check-tdd-progress.sh` passes

### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** skipped (checksum-only change, no code to refactor)

**Depends on:** Slice 1, Slice 2, Slice 3, Slice 4, Slice 5 | **Blocks:** None

---

## Slice Overview

| # | Slice | Dependencies |
|---|-------|-------------|
| 1 | Pipe bypass detection in bash guard | None |
| 2 | Lock-file gate + rm exception in bash guard | Slice 1 |
| 3 | Lock lifecycle — creation and cleanup | Slice 2 |
| 4 | Approval marker + simplified messaging | None |
| 5 | Prompt updates — approval flow | Slices 2, 3 |
| 6 | Update hook checksums | Slices 1-5 |

---

## Implementation Notes

### Design Principle
Behavioral/prompt fixes alone cannot solve "compaction loses instructions." The primary gate MUST be structural (filesystem + hooks that run fresh per call). Prompt-based guards are kept as a soft defense layer.

### Defense-in-Depth Layers
| Layer | Survives Compaction? | Role |
|-------|---------------------|------|
| `.tdd-plan-locked` file | Yes (filesystem) | Blocks writes until approval |
| Bash guard checking lock | Yes (runs fresh per call) | Enforces the lock |
| Bash guard pipe detection | Yes (runs fresh per call) | Closes `tee` bypass |
| SubagentStart creating lock | Yes (fires before agent) | Ensures lock exists |
| SubagentStop cleaning lock | Yes (fires after agent) | Handles abort/crash |
| `Approved:` marker in file | Yes (persisted in file) | Downstream validation |
| tdd-implement Step -1 | Yes (fresh agent reads file) | Catches any remaining bypass |
| Stop hook approval check | Yes (reads filesystem) | Won't trap user with unapproved plan |
| Prompt-based compaction guard | No (soft defense) | Belt-and-suspenders |

### Verification Commands
```bash
bashunit test/hooks/planner_bash_guard_test.sh
bashunit test/hooks/check_tdd_progress_test.sh
bashunit test/hooks/validate_plan_output_test.sh
shellcheck -S warning hooks/planner-bash-guard.sh hooks/validate-plan-output.sh hooks/check-tdd-progress.sh
```
