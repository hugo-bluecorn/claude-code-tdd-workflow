# TDD Task: /tdd-release Skill and tdd-releaser Agent (N6)

**Status:** pending
**Created:** 2026-02-16
**Last Updated:** 2026-02-16

---

## Feature Description

Implement a release workflow that finalizes completed TDD features. The `/tdd-release`
command delegates to a `tdd-releaser` agent (context-isolated, Sonnet model) that
validates all slices are terminal, runs the full test suite + static analysis + formatter,
updates CHANGELOG.md from slice descriptions, commits and pushes the branch, and creates
a PR via `gh`. A stop hook (`check-release-complete.sh`) validates the branch is pushed
before the agent can exit. This completes the four-phase TDD architecture:
plan -> implement -> verify -> **release**.

---

## Requirements

### Functional Requirements
- [ ] Stop hook (`check-release-complete.sh`) validates branch pushed to remote
- [ ] Agent definition (`tdd-releaser.md`) has correct tool restrictions (no Write/Edit)
- [ ] Skill definition (`skills/tdd-release/SKILL.md`) delegates to releaser via fork
- [ ] `hooks.json` has SubagentStop entry for tdd-releaser with timeout: 15
- [ ] Documentation updated: README, CLAUDE.md, user-guide.md, extensibility-audit.md, version-control-integration.md
- [ ] CHANGELOG updated and plugin version bumped

### Non-Functional Requirements
- [ ] All hook scripts pass shellcheck at warning level
- [ ] All existing tests continue to pass
- [ ] Test file naming follows project convention (`snake_case_test.sh`)

---

## Slice 1: check-release-complete.sh Stop Hook

**Status:** done

**Source:** `hooks/check-release-complete.sh`
**Tests:** `test/hooks/check_release_complete_test.sh`

### Test 1: stop_hook_active guard bypasses validation

**Description:** When stop_hook_active is true, the hook exits immediately without checking git state (prevents infinite loops, matching existing pattern in check-tdd-progress.sh).

**Given:**
- The hook script exists and is executable
- JSON input has `stop_hook_active: true`

**When:**
- The hook is invoked with the JSON piped to stdin

**Then:**
- Exit code is 0
- stdout is empty (no block/error output)

### Test 2: Not in a git repo exits gracefully

**Description:** When invoked outside a git repository, the hook allows the stop rather than failing.

**Given:**
- The hook script is invoked in a temporary directory that is NOT a git repository

**When:**
- The hook is invoked with `stop_hook_active: false`

**Then:**
- Exit code is 0
- stdout is empty

### Test 3: Branch pushed to remote exits 0

**Description:** When HEAD matches the upstream tracking branch, the hook allows the stop.

**Given:**
- The hook is invoked inside a git repository
- The current branch has an upstream tracking branch
- HEAD matches `@{upstream}` (branch is pushed)

**When:**
- The hook is invoked with `stop_hook_active: false`

**Then:**
- Exit code is 0
- stdout is empty

### Test 4: Branch not pushed to remote exits 2

**Description:** When HEAD does not match upstream (local commits not pushed), the hook blocks the stop.

**Given:**
- The hook is invoked inside a git repository
- The current branch has an upstream tracking branch
- HEAD does NOT match `@{upstream}` (unpushed commits exist)

**When:**
- The hook is invoked with `stop_hook_active: false`

**Then:**
- Exit code is 2
- stderr contains a message about branch not being pushed

### Test 5: No upstream tracking branch exits 2

**Description:** When the branch has no upstream configured, the hook blocks the stop (branch hasn't been pushed at all).

**Given:**
- The hook is invoked inside a git repository
- The current branch has NO upstream tracking branch

**When:**
- The hook is invoked with `stop_hook_active: false`

**Then:**
- Exit code is 2
- stderr contains a message about no upstream

### Edge Cases

**Test 6: Missing stop_hook_active field**

**Given:**
- JSON input is empty (`{}`) — missing `stop_hook_active` field

**When:**
- The hook is invoked

**Then:**
- The hook treats missing field as false and proceeds to git validation
- Behavior matches the not-in-git-repo or git-check path depending on context

**Test 7: Detached HEAD**

**Given:**
- The hook is invoked on a detached HEAD (no branch name)

**When:**
- The hook is invoked with `stop_hook_active: false`

**Then:**
- Exit code is 2
- stderr contains a message about detached HEAD or no upstream

### Acceptance Criteria
- [ ] All tests pass
- [ ] Script passes shellcheck at warning level
- [ ] Script is executable (chmod +x)
- [ ] Follows existing hook patterns (jq for JSON, stop_hook_active guard)

### Phase Tracking

- **RED:** pass
- **GREEN:** pass
- **REFACTOR:** pass

**Depends on:** none | **Blocks:** Slice 4

---

## Slice 2: tdd-releaser Agent Definition

**Status:** done

**Source:** `agents/tdd-releaser.md`
**Tests:** `test/agents/tdd_releaser_test.sh`

### Test 1: Agent frontmatter has correct tools

**Description:** The agent definition must list only Read, Bash, Glob, Grep, AskUserQuestion as allowed tools.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The frontmatter is parsed for the `tools` field

**Then:**
- The tools field contains exactly: `Read, Bash, Glob, Grep, AskUserQuestion`

### Test 2: Agent frontmatter has correct disallowedTools

**Description:** Write, Edit, MultiEdit, and NotebookEdit must all be disallowed to enforce CHANGELOG-only file modifications via Bash.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The frontmatter is parsed for the `disallowedTools` field

**Then:**
- The disallowedTools field contains: `Write, Edit, MultiEdit, NotebookEdit`

### Test 3: Agent uses sonnet model

**Description:** The releaser is a procedural workflow, not a research task — sonnet is sufficient.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The frontmatter is parsed for the `model` field

**Then:**
- The model is `sonnet`

### Test 4: Agent has stop hook referencing check-release-complete.sh

**Description:** The agent definition must reference the stop hook to enforce branch-pushed validation.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The frontmatter is parsed for hooks configuration

**Then:**
- A Stop hook entry references `${CLAUDE_PLUGIN_ROOT}/hooks/check-release-complete.sh`

### Test 5: Agent does NOT have memory field

**Description:** Each release is independent — no cross-session learning needed.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The frontmatter is inspected for a `memory` field

**Then:**
- No `memory` field is present in the frontmatter

### Test 6: Agent body contains CHANGELOG workflow

**Description:** The agent system prompt must instruct the releaser how to update CHANGELOG via Bash.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The body (below frontmatter) is inspected

**Then:**
- The body contains instructions about CHANGELOG.md updates
- The body contains instructions about using Bash (sed/echo) for file modifications

### Test 7: Agent body contains PR creation workflow

**Description:** The agent must know how to create a PR via `gh` with graceful degradation.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The body is inspected

**Then:**
- The body references `gh pr create`
- The body contains fallback instructions when `gh` is unavailable

### Test 8: Agent body contains project-type aware formatter step

**Description:** The formatter must detect Dart, C++, or Bash projects and apply the appropriate tool.

**Given:**
- The file `agents/tdd-releaser.md` exists

**When:**
- The body is inspected for formatter instructions

**Then:**
- The body mentions `dart format` for Dart projects
- The body mentions formatter handling for non-Dart projects (skip or appropriate tool)

### Edge Cases

**Test 9: Task tool not in agent tools**

**Given:**
- The agent file is inspected for the `Task` tool

**When:**
- The tools and disallowedTools fields are checked

**Then:**
- `Task` does NOT appear in the tools list (releaser should not spawn sub-agents)

### Acceptance Criteria
- [ ] All tests pass
- [ ] Agent frontmatter is valid YAML
- [ ] Agent follows existing agent pattern (matches structure of tdd-verifier.md)

### Phase Tracking

- **RED:** pass
- **GREEN:** pass
- **REFACTOR:** skip

**Depends on:** none | **Blocks:** Slice 3, Slice 4

---

## Slice 3: /tdd-release Skill Definition

**Status:** done

**Source:** `skills/tdd-release/SKILL.md`
**Tests:** `test/skills/tdd_release_test.sh`

### Test 1: Skill frontmatter has correct name

**Description:** The skill must be named `tdd-release` to be invocable as `/tdd-release`.

**Given:**
- The file `skills/tdd-release/SKILL.md` exists

**When:**
- The frontmatter is parsed for the `name` field

**Then:**
- The name is `tdd-release`

### Test 2: Skill delegates to tdd-releaser agent

**Description:** The skill must specify `agent: tdd-releaser` in frontmatter.

**Given:**
- The file `skills/tdd-release/SKILL.md` exists

**When:**
- The frontmatter is parsed for the `agent` field

**Then:**
- The agent is `tdd-releaser`

### Test 3: Skill uses forked context

**Description:** The release workflow runs in a forked context to keep noisy output out of the main conversation.

**Given:**
- The file `skills/tdd-release/SKILL.md` exists

**When:**
- The frontmatter is parsed for the `context` field

**Then:**
- The context is `fork`

### Test 4: Skill has disable-model-invocation set

**Description:** The skill should only be user-invocable (via `/tdd-release`), not auto-triggered by Claude.

**Given:**
- The file `skills/tdd-release/SKILL.md` exists

**When:**
- The frontmatter is parsed for the `disable-model-invocation` field

**Then:**
- `disable-model-invocation` is `true`

### Test 5: Skill body contains release workflow steps

**Description:** The skill body must contain the ordered release workflow steps.

**Given:**
- The file `skills/tdd-release/SKILL.md` exists

**When:**
- The body content is inspected

**Then:**
- Body references verifying all slices terminal in `.tdd-progress.md`
- Body references refusing to release from main/master
- Body references running test suite
- Body references running static analysis
- Body references running formatter (project-type aware)
- Body references updating CHANGELOG.md
- Body references creating PR via `gh`
- Body references optional cleanup of `.tdd-progress.md`

### Edge Cases

**Test 6: Description contains trigger phrases**

**Given:**
- The skill file is checked for description containing trigger phrases

**When:**
- The `description` field is inspected

**Then:**
- The description contains relevant trigger phrases (e.g., "release", "finalize", "publish")

### Acceptance Criteria
- [x] All tests pass
- [x] Skill frontmatter matches existing skill patterns (compare to tdd-plan/SKILL.md)
- [x] Skill body covers all release workflow steps from requirements

### Phase Tracking

- **RED:** pass
- **GREEN:** pass
- **REFACTOR:** skip

**Depends on:** Slice 2 | **Blocks:** Slice 5

---

## Slice 4: hooks.json Integration

**Status:** done

**Source:** `hooks/hooks.json`
**Tests:** `test/hooks/hooks_json_releaser_test.sh`

### Test 1: hooks.json contains SubagentStop entry for tdd-releaser

**Description:** The hooks.json file must have a SubagentStop entry that triggers for the tdd-releaser agent.

**Given:**
- The file `hooks/hooks.json` exists and is valid JSON

**When:**
- The `SubagentStop` array is inspected

**Then:**
- An entry with `matcher: "tdd-releaser"` exists

### Test 2: SubagentStop entry references check-release-complete.sh

**Description:** The stop hook command must point to the correct script using `${CLAUDE_PLUGIN_ROOT}`.

**Given:**
- The file `hooks/hooks.json` exists
- The SubagentStop entry for tdd-releaser exists

**When:**
- The hook command is inspected

**Then:**
- The command contains `${CLAUDE_PLUGIN_ROOT}/hooks/check-release-complete.sh`

### Test 3: SubagentStop entry is a command hook (not prompt)

**Description:** Branch-pushed validation is deterministic — command hook is appropriate.

**Given:**
- The hooks.json SubagentStop entry for tdd-releaser exists

**When:**
- The hook type is inspected

**Then:**
- The type is `command`

### Test 4: hooks.json remains valid JSON after modification

**Description:** The modified hooks.json must parse as valid JSON.

**Given:**
- The file `hooks/hooks.json` exists

**When:**
- The file is parsed with `jq .`

**Then:**
- jq exits with code 0 (valid JSON)

### Test 5: SubagentStop timeout for tdd-releaser is 15 seconds

**Description:** Release operations like git push may take longer than plan validation. The tdd-releaser SubagentStop hook should use timeout: 15 (vs the tdd-planner's timeout: 10).

**Given:**
- The file `hooks/hooks.json` exists
- The SubagentStop entry for tdd-releaser exists

**When:**
- The timeout value of the tdd-releaser SubagentStop hook is inspected

**Then:**
- The timeout is 15

### Edge Cases

**Test 6: Existing SubagentStop entries preserved**

**Given:**
- The existing SubagentStop entries (tdd-implementer, tdd-planner) are inspected

**When:**
- hooks.json is parsed

**Then:**
- The existing entries are NOT modified or removed
- The tdd-releaser entry is added alongside existing entries

### Acceptance Criteria
- [ ] All tests pass
- [ ] hooks.json is valid JSON
- [ ] Existing hook entries are preserved
- [ ] Timeout for tdd-releaser SubagentStop is 15 seconds

### Phase Tracking

- **RED:** pass
- **GREEN:** pass
- **REFACTOR:** skip

**Depends on:** Slice 1, Slice 2 | **Blocks:** Slice 5

---

## Slice 5: Documentation Updates

**Status:** done

**Source:** `README.md`, `CLAUDE.md`, `docs/user-guide.md`, `docs/tdd-workflow-extensibility-audit.md`, `docs/version-control-integration.md`
**Tests:** `test/integration/release_documentation_test.sh`

### Test 1: README mentions /tdd-release skill

**Description:** The README must list `/tdd-release` alongside `/tdd-plan` and `/tdd-implement`.

**Given:**
- The file `README.md` exists

**When:**
- The content is searched for `/tdd-release` or `tdd-release`

**Then:**
- `/tdd-release` appears in the Skills table
- `tdd-releaser` appears in the Agents table
- `check-release-complete.sh` appears in the Hooks table
- The file structure section includes the new files

### Test 2: README workflow diagram includes release phase

**Description:** The ASCII workflow diagram should show the release phase after verification.

**Given:**
- The file `README.md` exists

**When:**
- The content is inspected for the workflow diagram

**Then:**
- The diagram includes a `tdd-releaser` step after the verify loop

### Test 3: CLAUDE.md mentions /tdd-release

**Description:** The CLAUDE.md available commands section must include `/tdd-release`.

**Given:**
- The file `CLAUDE.md` exists

**When:**
- The content is searched for `/tdd-release`

**Then:**
- `/tdd-release` appears in the Available Commands section with description

### Test 4: user-guide.md documents the release workflow

**Description:** The user guide must have a section explaining how to use `/tdd-release`.

**Given:**
- The file `docs/user-guide.md` exists

**When:**
- The content is searched for release workflow documentation

**Then:**
- A section for `/tdd-release` or "Release" workflow exists
- The section describes what the command does
- The section mentions approval gates (CHANGELOG, PR, cleanup)

### Test 5: extensibility-audit.md N6 updated

**Description:** The N6 item in the extensibility audit must be marked as implemented.

**Given:**
- The file `docs/tdd-workflow-extensibility-audit.md` exists

**When:**
- The N6 row is inspected

**Then:**
- N6 status includes a completion marker (e.g., "Applied" or version reference)

### Test 6: version-control-integration.md Layer 3 marked as implemented

**Description:** The Layer 3 section currently says "NOT YET IMPLEMENTED". After N6, it should say "IMPLEMENTED v1.6.0" matching the Layer 1/2 pattern.

**Given:**
- The file `docs/version-control-integration.md` exists

**When:**
- The Layer 3 heading and status are inspected

**Then:**
- The Layer 3 section contains "IMPLEMENTED" (not "NOT YET IMPLEMENTED")
- The version reference is "v1.6.0"
- The summary table row for `/tdd-release` shows a completion status

### Edge Cases

**Test 7: Audit directory structure includes new files**

**Given:**
- The audit document's directory structure listing is inspected

**When:**
- The structure is checked for new files

**Then:**
- `agents/tdd-releaser.md` appears in the directory listing
- `skills/tdd-release/` appears in the directory listing
- `hooks/check-release-complete.sh` appears in the directory listing

### Acceptance Criteria
- [ ] All tests pass
- [ ] All five documentation files updated consistently
- [ ] No stale references to three-agent architecture (now four agents)
- [ ] version-control-integration.md Layer 3 marked IMPLEMENTED v1.6.0

### Phase Tracking

- **RED:** pass
- **GREEN:** pass
- **REFACTOR:** skip

**Depends on:** Slice 3, Slice 4 | **Blocks:** Slice 6

---

## Slice 6: CHANGELOG and Version Bump

**Status:** done

**Source:** `CHANGELOG.md`, `.claude-plugin/plugin.json`
**Tests:** `test/integration/release_version_test.sh`

### Test 1: CHANGELOG has entry for new version

**Description:** The CHANGELOG must document the new release workflow feature.

**Given:**
- The file `CHANGELOG.md` exists

**When:**
- The content is inspected for a new version section

**Then:**
- A section header exists for the new version (e.g., `## [1.6.0]`)
- The section contains "Added" entries for `/tdd-release`, `tdd-releaser`, `check-release-complete.sh`

### Test 2: plugin.json version bumped

**Description:** The plugin manifest must have its version incremented.

**Given:**
- The file `.claude-plugin/plugin.json` exists

**When:**
- The `version` field is inspected

**Then:**
- The version is `1.6.0` (minor bump for new feature)

### Test 3: CHANGELOG version matches plugin.json version

**Description:** The latest CHANGELOG version and plugin.json version must be consistent.

**Given:**
- Both `CHANGELOG.md` and `.claude-plugin/plugin.json` exist

**When:**
- The latest version from CHANGELOG and the version from plugin.json are compared

**Then:**
- They match

### Edge Cases

**Test 4: Previous CHANGELOG entries unchanged**

**Given:**
- The CHANGELOG is inspected for the previous version entry

**When:**
- The `[1.5.0]` section is checked

**Then:**
- It remains unchanged (no accidental modifications to existing entries)

### Acceptance Criteria
- [ ] All tests pass
- [ ] Version follows semantic versioning (minor bump for new feature)
- [ ] CHANGELOG follows Keep a Changelog format

### Phase Tracking

- **RED:** pass
- **GREEN:** pass
- **REFACTOR:** skip

**Depends on:** Slice 5 | **Blocks:** none

---

## Implementation Requirements

### File Structure

```
tdd-workflow/
+-- agents/
|   +-- tdd-releaser.md                      (NEW)
+-- skills/
|   +-- tdd-release/
|       +-- SKILL.md                         (NEW)
+-- hooks/
|   +-- hooks.json                           (MODIFIED)
|   +-- check-release-complete.sh            (NEW)
+-- test/
|   +-- hooks/
|   |   +-- check_release_complete_test.sh   (NEW)
|   |   +-- hooks_json_releaser_test.sh      (NEW)
|   +-- agents/
|   |   +-- tdd_releaser_test.sh             (NEW)
|   +-- skills/
|   |   +-- tdd_release_test.sh              (NEW)
|   +-- integration/
|       +-- release_documentation_test.sh    (NEW)
|       +-- release_version_test.sh          (NEW)
+-- docs/
|   +-- user-guide.md                        (MODIFIED)
|   +-- tdd-workflow-extensibility-audit.md  (MODIFIED)
|   +-- version-control-integration.md       (MODIFIED)
+-- .claude-plugin/
|   +-- plugin.json                          (MODIFIED)
+-- CLAUDE.md                                (MODIFIED)
+-- CHANGELOG.md                             (MODIFIED)
+-- README.md                                (MODIFIED)
```

### Test Framework Detection
- **Bash:** bashunit for tests, shellcheck for static analysis (matching existing project patterns)

### Dependencies Required
- [ ] bashunit (already installed)
- [ ] shellcheck (already installed)
- [ ] jq (already used by existing hooks)
- [ ] git (for stop hook git operations)
- [ ] No external packages needed

### Edge Cases to Handle
- [ ] Missing `jq` on system (hook should degrade gracefully)
- [ ] Not in a git repository
- [ ] Detached HEAD state
- [ ] No upstream tracking branch
- [ ] `gh` CLI not installed (graceful degradation in skill)

---

## Acceptance Criteria

- [ ] All new tests pass (6 test files)
- [ ] All existing tests still pass (11 existing test files)
- [ ] `shellcheck -S warning` passes on all new `.sh` files
- [ ] No static analysis errors
- [ ] No breaking changes to existing hooks, agents, or skills
- [ ] Documentation is consistent across all updated files

---

## Implementation Notes

### Architectural Decisions
- **Edit excluded from agent tools:** The releaser must only modify CHANGELOG.md — enforced by excluding all write tools except Bash. Bash with `sed`/`echo` allows targeted CHANGELOG modifications while preventing arbitrary file edits.
- **Sonnet model:** The releaser is a procedural workflow (run tests, update file, push, create PR). It doesn't need opus-level reasoning.
- **Forked context:** Release output (test results, git output) is noisy — keeping it out of the main conversation improves UX.
- **Version bump out of scope:** Differs across Dart (pubspec.yaml), C++ (CMakeLists.txt), and Bash (no standard). The releaser doesn't attempt this.
- **Stop hook only checks branch pushed:** CHANGELOG and PR are user-skippable via AskUserQuestion approval gates. The stop hook enforces the one non-negotiable requirement: code must be pushed.
- **CHANGELOG entries from slice names:** The releaser reads `.tdd-progress.md` for slice descriptions rather than parsing git log. This produces cleaner, more intentional entries.
- **SubagentStop timeout: 15:** Release operations (git push, gh pr create) may take longer than plan validation (10s). 15s provides headroom.

---

## Status Vocabulary

| Status | Meaning |
|--------|---------|
| `pending` | Not yet started |
| `in-progress` | Currently being worked on |
| `done` | Completed successfully |
| `pass` | Test/verification passed |
| `fail` | Test/verification failed |
| `skip` | Intentionally skipped |
