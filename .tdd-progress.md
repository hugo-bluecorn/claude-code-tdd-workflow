# TDD Task: Phase 2 Planner Safety Hooks (M1, M2, S2)

**Status:** done
**Created:** 2026-02-15
**Last Updated:** 2026-02-15

---

## Feature Description

The tdd-planner agent is read-only by design (`Write`, `Edit`, `MultiEdit` in
`disallowedTools`) but the `Bash` tool can still write files via output
redirection or destructive commands. Phase 2 adds three safety guardrails:

- **M1** — A PreToolUse `Bash` guard that allowlists read-only commands and blocks redirection
- **M2** — A Stop hook that validates the planner produced a complete plan file before stopping
- **S2** — A SubagentStop entry in `hooks.json` that reuses M2's validator as defense-in-depth

---

## Requirements

### Functional Requirements
- [ ] `planner-bash-guard.sh` reads PreToolUse JSON from stdin and extracts `tool_input.command` via jq
- [ ] Only allowlisted commands are permitted (find, grep, rg, cat, head, tail, wc, ls, tree, file, stat, du, df, git, flutter, dart, fvm, test, command, which, type, pwd, echo)
- [ ] Output redirection (`>`) is blocked except to `/dev/null` and `planning/`
- [ ] Leading env var assignments are stripped before extracting the base command
- [ ] `validate-plan-output.sh` checks `stop_hook_active` to prevent infinite loops
- [ ] Validator finds a plan file in `planning/` modified in the last 30 minutes
- [ ] Validator checks for required sections: "feature analysis" and "test specification" or "slice" headings
- [ ] Validator detects refactoring leak (`refactor:`, `refactoring phase`, `REFACTOR phase`)
- [ ] `hooks.json` has a SubagentStop entry for `tdd-planner` reusing the validator
- [ ] `tdd-planner.md` frontmatter has PreToolUse (Bash matcher) and Stop hooks

### Non-Functional Requirements
- [ ] All scripts pass `shellcheck -S warning`
- [ ] All scripts pass bashunit tests
- [ ] Existing 143 tests remain green
- [ ] Existing hooks (`validate-tdd-order.sh`, `auto-run-tests.sh`, `check-tdd-progress.sh`) are NOT modified

---

## Test Specifications

### Slice 1: Bash Guard — Command Allowlist

**Status:** done

**Source:** `hooks/planner-bash-guard.sh`
**Tests:** `test/hooks/planner_bash_guard_test.sh`

#### Test 1: Allows allowlisted read-only commands

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"cat README.md"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 0

#### Test 2: Blocks non-allowlisted commands

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"rm -rf /tmp/data"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2
- stderr contains "BLOCKED" and "not in the planner's allowlist"

#### Test 3: Allows commands with leading env var assignments

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"FOO=bar grep pattern file.txt"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 0 (the base command `grep` is allowlisted)

#### Test 4: Blocks non-allowlisted commands with leading env vars

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"FOO=bar python3 -c 'import os'"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2
- stderr contains "BLOCKED"

#### Test 5: Each allowlisted command is individually accepted

**Given:**
- PreToolUse JSON with `tool_input.command` set to each of the allowlisted commands (find, grep, rg, cat, head, tail, wc, ls, tree, file, stat, du, df, git, flutter, dart, fvm, test, command, which, type, pwd, echo)

**When:**
- Each JSON is piped to `planner-bash-guard.sh`

**Then:**
- Every command exits with code 0

#### Edge Cases

**Given:**
- PreToolUse JSON with `tool_input.command` set to `""` (empty command)

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2 (empty is not in the allowlist)

**Given:**
- PreToolUse JSON with no `tool_input.command` field (missing key)

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2 (jq returns empty string, which is not allowlisted)

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"grep-extended foo"` (partial match)

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2 (exact match required, `grep-extended` is not `grep`)

#### Acceptance Criteria
- [ ] All tests pass
- [ ] Allowlisted commands exit 0
- [ ] Non-allowlisted commands exit 2 with informative stderr message
- [ ] Leading env var assignments are correctly stripped
- [ ] Script passes `shellcheck -S warning`

#### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** none | **Blocks:** Slice 2, Slice 5

---

### Slice 2: Bash Guard — Redirection Blocking

**Status:** done

**Source:** `hooks/planner-bash-guard.sh`
**Tests:** `test/hooks/planner_bash_guard_test.sh`

#### Test 1: Blocks output redirection to arbitrary paths

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"echo hello > /tmp/output.txt"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2
- stderr contains "BLOCKED" and "redirection"

#### Test 2: Allows redirection to /dev/null

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"git status > /dev/null"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 0

#### Test 3: Allows redirection to planning/ directory

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"echo content > planning/notes.md"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 0

#### Test 4: Allows redirection to ./planning/ with dot prefix

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"echo content > ./planning/notes.md"`

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 0

#### Edge Cases

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"ls -la >> /tmp/log.txt"` (append redirection)

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 2 (append redirection `>>` also matches `>`)

**Given:**
- PreToolUse JSON with `tool_input.command` set to `"ls 2>/dev/null"` (stderr redirection to /dev/null)

**When:**
- The JSON is piped to `planner-bash-guard.sh`

**Then:**
- Exit code is 0 (redirection to /dev/null is allowed)

#### Acceptance Criteria
- [ ] All tests pass
- [ ] Redirection to arbitrary paths is blocked with exit 2
- [ ] Redirection to `/dev/null` is allowed
- [ ] Redirection to `planning/` and `./planning/` is allowed
- [ ] Append redirection `>>` is also caught
- [ ] Script passes `shellcheck -S warning`

#### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** Slice 1 | **Blocks:** Slice 5

---

### Slice 3: Plan Validator — File Existence and Stop Hook Guard

**Status:** done

**Source:** `hooks/validate-plan-output.sh`
**Tests:** `test/hooks/validate_plan_output_test.sh`

#### Test 1: Exits 0 when stop_hook_active is true

**Given:**
- Stop hook JSON with `"stop_hook_active": true`

**When:**
- The JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 0 (infinite loop prevention)

#### Test 2: Exits 2 when no plan file exists in planning/

**Given:**
- Stop hook JSON with `"stop_hook_active": false`
- An empty or nonexistent `planning/` directory

**When:**
- The JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2
- stderr contains "No plan file found"

#### Test 3: Exits 0 when valid plan file exists with recent modification time

**Given:**
- Stop hook JSON with `"stop_hook_active": false`
- A `planning/` directory containing a `.md` file modified within the last 30 minutes
- The file contains required sections (Feature Analysis heading, Slice heading)

**When:**
- The JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 0

#### Edge Cases

**Given:**
- Stop hook JSON with no `stop_hook_active` field

**When:**
- The JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2 (not `true`, so validation proceeds; if no plan file, blocked)

**Given:**
- A `planning/` directory containing a `.md` file that is older than 30 minutes

**When:**
- The JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2 (file exists but too old; stderr indicates no recent plan file)

#### Acceptance Criteria
- [ ] All tests pass
- [ ] `stop_hook_active: true` immediately exits 0
- [ ] Missing plan file exits 2 with descriptive stderr
- [ ] Recent valid plan file exits 0
- [ ] Stale plan file (>30 min) exits 2
- [ ] Script passes `shellcheck -S warning`

#### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** none | **Blocks:** Slice 4, Slice 5

---

### Slice 4: Plan Validator — Section Checks and Refactoring Leak

**Status:** done

**Source:** `hooks/validate-plan-output.sh`
**Tests:** `test/hooks/validate_plan_output_test.sh`

#### Test 1: Exits 2 when required "feature analysis" section is missing

**Given:**
- A recent plan file in `planning/` that contains a `## Slice 1` heading but no heading containing "feature analysis"

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2
- stderr contains "missing required sections" and "Feature-Analysis"

#### Test 2: Exits 2 when required test specification/slice sections are missing

**Given:**
- A recent plan file in `planning/` that contains a heading with "Feature Analysis" but no heading containing "test specification" or "slice"

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2
- stderr contains "missing required sections" and "Test-Specification"

#### Test 3: Exits 0 when all required sections are present

**Given:**
- A recent plan file in `planning/` with headings:
  - `## Feature Analysis`
  - `## Slice 1: Something`

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 0

#### Test 4: Exits 2 when refactoring leak is detected (refactor: commit type)

**Given:**
- A recent plan file in `planning/` with all required sections
- The file contains the text `refactor: clean up authentication`

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2
- stderr contains "REFACTORING LEAK"

#### Test 5: Exits 2 when refactoring leak is detected (REFACTOR Phase)

**Given:**
- A recent plan file in `planning/` with all required sections
- The file contains the text `REFACTOR Phase`

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 2
- stderr contains "REFACTORING LEAK"

#### Edge Cases

**Given:**
- A recent plan file with all required sections
- The file contains the word "refactoring" standalone (not followed by "phase")

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 0 (only exact patterns `refactor:`, `refactoring phase`, `REFACTOR phase` are checked)

**Given:**
- A recent plan file with case variations: `## FEATURE ANALYSIS` and `### slice 1`

**When:**
- Stop hook JSON is piped to `validate-plan-output.sh`

**Then:**
- Exit code is 0 (grep uses `-i` for case-insensitive matching)

#### Acceptance Criteria
- [ ] All tests pass
- [ ] Missing "feature analysis" heading exits 2
- [ ] Missing "test specification"/"slice" heading exits 2
- [ ] Both missing sections reported together in stderr
- [ ] Refactoring leak patterns exit 2
- [ ] Standalone "refactoring" without "phase" does NOT trigger leak detection
- [ ] Section matching is case-insensitive
- [ ] Script passes `shellcheck -S warning`

#### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** Slice 3 | **Blocks:** Slice 5

---

### Slice 5: Integration — Planner Frontmatter and hooks.json SubagentStop

**Status:** done

**Source:** `agents/tdd-planner.md`, `hooks/hooks.json`
**Tests:** `test/hooks/planner_bash_guard_test.sh`, `test/hooks/validate_plan_output_test.sh`

#### Test 1: Planner frontmatter contains PreToolUse Bash hook

**Given:**
- The file `agents/tdd-planner.md`

**When:**
- The file content is inspected

**Then:**
- The YAML frontmatter contains a `hooks:` key
- Under `hooks:`, there is a `PreToolUse:` entry with `matcher: "Bash"`
- The hook type is `command` pointing to `${CLAUDE_PLUGIN_ROOT}/hooks/planner-bash-guard.sh`

#### Test 2: Planner frontmatter contains Stop hook

**Given:**
- The file `agents/tdd-planner.md`

**When:**
- The file content is inspected

**Then:**
- Under `hooks:`, there is a `Stop:` entry
- The hook type is `command` pointing to `${CLAUDE_PLUGIN_ROOT}/hooks/validate-plan-output.sh`

#### Test 3: hooks.json contains SubagentStop entry for tdd-planner

**Given:**
- The file `hooks/hooks.json`

**When:**
- The JSON is parsed with jq

**Then:**
- `.hooks.SubagentStop` array has an entry with `"matcher": "tdd-planner"`
- That entry has a command hook pointing to `${CLAUDE_PLUGIN_ROOT}/hooks/validate-plan-output.sh`
- The timeout is 10

#### Test 4: hooks.json is valid JSON and existing entries are preserved

**Given:**
- The file `hooks/hooks.json`

**When:**
- The JSON is parsed with jq

**Then:**
- jq exits 0 (valid JSON)
- The existing `tdd-implementer` SubagentStop entry is still present
- The existing Stop hook (`check-tdd-progress.sh`) is still present

#### Test 5: Existing hooks are unmodified

**Given:**
- The files `hooks/validate-tdd-order.sh`, `hooks/auto-run-tests.sh`, `hooks/check-tdd-progress.sh`

**When:**
- File checksums are compared against known values

**Then:**
- None of the existing hook scripts have been modified (checksums match)

#### Edge Cases

**Given:**
- The file `agents/tdd-planner.md`

**When:**
- The frontmatter is inspected for the existing fields

**Then:**
- All existing frontmatter fields are preserved: `name`, `description`, `tools`, `disallowedTools`, `model`, `permissionMode`, `maxTurns`, `skills`
- The `hooks` key is additive, not replacing existing content

#### Acceptance Criteria
- [ ] All tests pass
- [ ] Planner frontmatter has both PreToolUse and Stop hooks
- [ ] hooks.json has SubagentStop entry for tdd-planner
- [ ] Existing hooks.json entries preserved
- [ ] Existing hook scripts unmodified
- [ ] hooks.json remains valid JSON
- [ ] All existing 143+ tests still pass

#### Phase Tracking

- **RED:** done
- **GREEN:** done
- **REFACTOR:** done

**Depends on:** Slice 1, Slice 2, Slice 3, Slice 4 | **Blocks:** none

---

## Implementation Requirements

### File Structure
- **Source:** `hooks/planner-bash-guard.sh` (new)
- **Source:** `hooks/validate-plan-output.sh` (new)
- **Modified:** `agents/tdd-planner.md` (add hooks frontmatter)
- **Modified:** `hooks/hooks.json` (add SubagentStop entry)
- **Tests:** `test/hooks/planner_bash_guard_test.sh` (new)
- **Tests:** `test/hooks/validate_plan_output_test.sh` (new)

### Test Framework Detection
- **Framework:** bashunit v0.32.0 (at `./lib/bashunit`)
- **Static analysis:** shellcheck
- **Runner:** `./lib/bashunit test/`

### Dependencies Required
- [ ] `jq` — for JSON parsing in hooks (already used by existing hooks)
- [ ] `shellcheck` — for static analysis (already available)
- [ ] External packages needed: no

### Edge Cases to Handle
- [ ] Empty or missing `tool_input.command` in stdin JSON
- [ ] Missing `stop_hook_active` field in stdin JSON
- [ ] Stale plan files (>30 minutes old)
- [ ] Partial allowlist match (e.g., `grep-extended` should NOT match `grep`)
- [ ] Redirection within allowed paths (`/dev/null`, `planning/`)
- [ ] Case-insensitive section heading matching
- [ ] `refactoring` without `phase` should not trigger leak detection

---

## Acceptance Criteria

- [ ] All new tests pass
- [ ] All existing 143 tests remain green
- [ ] `shellcheck -S warning hooks/planner-bash-guard.sh` passes
- [ ] `shellcheck -S warning hooks/validate-plan-output.sh` passes
- [ ] hooks.json is valid JSON
- [ ] Existing hooks are unmodified
- [ ] No breaking changes to agent frontmatter

---

## Implementation Notes

### Architectural Decisions
- **Allowlist over denylist (M1):** Round 2 audit consensus — allowlist is strictly safer than denylist
- **Shared validator script (M2/S2):** `validate-plan-output.sh` is used by both Stop and SubagentStop as defense-in-depth
- **Section name matching:** Case-insensitive grep accommodates heading variations

### Design Consideration: Template vs Validator
The M2 validator checks `planning/` files (feature-notes-template format), NOT `.tdd-progress.md`.
The feature-notes-template heading `### Potential Refactoring` does NOT match the leak regex
patterns (`refactor:`, `refactoring phase`, `REFACTOR phase`), so no false-positive concern.

---

## Test Results Tracking

### Iteration 1 (RED Phase)
**Status:** pending
**Failing Tests:** {number}
**Notes:** {observations}

### Iteration 2 (GREEN Phase)
**Status:** pending
**Tests Passed:** 0/{total} -> {total}/{total}
**Notes:** {how implementation satisfied tests}

### Iteration 3 (REFACTOR Phase)
**Status:** pending
**Tests Status:** pass
**Refactoring Done:** {description, or skip}
**Notes:** {final observations}

---

## Related Issues / Dependencies

- Depends on: Audit document `docs/tdd-workflow-extensibility-audit.md` sections 4.3, 4.4, 4.5
- Blocks: S1 (planner memory), S3 (SubagentStart context injection)

---

## Slice Summary

| # | Slice | Depends On | Blocks |
|---|-------|-----------|--------|
| 1 | Bash Guard — Command Allowlist | none | 2, 5 |
| 2 | Bash Guard — Redirection Blocking | 1 | 5 |
| 3 | Plan Validator — File Existence and Stop Hook Guard | none | 4, 5 |
| 4 | Plan Validator — Section Checks and Refactoring Leak | 3 | 5 |
| 5 | Integration — Planner Frontmatter and hooks.json SubagentStop | 1, 2, 3, 4 | none |

---

## Status Vocabulary

Use these values for all status fields in this document and in `.tdd-progress.md`:

| Status | Meaning |
|--------|---------|
| `pending` | Not yet started |
| `in-progress` | Currently being worked on |
| `done` | Completed successfully |
| `pass` | Test/verification passed |
| `fail` | Test/verification failed |
| `skip` | Intentionally skipped |
